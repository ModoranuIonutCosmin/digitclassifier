using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using Newtonsoft.Json;
using NUnit.Framework;
using PredictionHelpers.Models;

namespace Api.IntegrationTests
{
    [TestFixture]
    public class Tests: BaseOneTimeSetup
    {
        [Test]
        public async Task Post_Should_ReturnDigit2_GivenImageWithDigit2()
        {
          
            //Arrange
            PredictionRequest imagine = new PredictionRequest
            {
                Base64Image = @"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"
            };
          
            var x = JsonContent.Create(imagine);

            //Act
            var apiResponse = await Client.PostAsync("http://localhost:6969/api/ml", x);
    
            // Assert
            var response = JsonConvert.DeserializeObject<PredictionResponse>(await apiResponse.Content.ReadAsStringAsync());
            Assert.IsNotNull(response);
            Assert.AreEqual(6,response.DigitPredicted);
            Assert.GreaterOrEqual(response.PredictionLikelihood,0.4);
        }
        [Test]
        public async Task Post_Should_Not_ReturnDigit8_GivenImageWithDigit2()
        {
            // Act

            PredictionRequest imagine = new PredictionRequest
            {
                Base64Image = @"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"
            };
            var x = JsonContent.Create(imagine);
            var apiResponse = await Client.PostAsync("http://localhost:6969/api/ml", x);

            // Assert
            var response = JsonConvert.DeserializeObject<PredictionResponse>(await apiResponse.Content.ReadAsStringAsync());
            Assert.IsNotNull(response);
            Assert.AreNotEqual(8, response.DigitPredicted);
       
        }
    }
}